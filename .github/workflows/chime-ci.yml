name: chime CI

on:
  push:
    paths:
      - "chime/**"
      - "common/**"
      - "scripts/chime_ci.sh"
      - ".github/workflows/chime-ci.yml"
      - ".clang-format"
      - ".clang-tidy"
  pull_request:
    paths:
      - "chime/**"
      - "common/**"
      - "scripts/chime_ci.sh"
      - ".github/workflows/chime-ci.yml"
      - ".clang-format"
      - ".clang-tidy"
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build_type: [Release]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up CMake 4.x
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "4.0.0"

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ninja-build pkg-config \
            libmosquitto-dev \
            libssl-dev \
            clang-format clang-tidy

      - name: Determine CI file scope
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"
            echo "CHIME_CI_SCOPE=changed" >> "$GITHUB_ENV"
            echo "CHIME_CI_BASE_REF=origin/${{ github.base_ref }}" >> "$GITHUB_ENV"
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            echo "CHIME_CI_SCOPE=changed" >> "$GITHUB_ENV"
            echo "CHIME_CI_BASE_REF=${{ github.event.before }}" >> "$GITHUB_ENV"
          else
            echo "CHIME_CI_SCOPE=all" >> "$GITHUB_ENV"
          fi

      - name: Run chime CI checks
        env:
          BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          ./scripts/chime_ci.sh
