#!/bin/sh

DAEMON="networking"

start() {
    printf "Starting %s: " "$DAEMON"
    
    # Bring up loopback
    /sbin/ifconfig lo up
    
    # Load Wi-Fi driver module if not loaded
    modprobe brcmfmac 2>/dev/null || true
    
    # Small delay for Wi-Fi hardware to initialize
    sleep 2
    
    # Bring up wlan0 with wpa_supplicant
    if [ -f /etc/wpa_supplicant/wpa_supplicant.conf ]; then
        wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf
        sleep 1
        /sbin/ifconfig wlan0 up
        # Request DHCP lease
        udhcpc -i wlan0 -b -p /var/run/udhcpc.wlan0.pid -S
    else
        echo "WARNING: /etc/wpa_supplicant/wpa_supplicant.conf not found!"
        echo "Copy wpa_supplicant.conf.example and configure your Wi-Fi."
    fi
    
    echo "OK"
}

stop() {
    printf "Stopping %s: " "$DAEMON"
    
    # Kill DHCP client
    if [ -f /var/run/udhcpc.wlan0.pid ]; then
        kill $(cat /var/run/udhcpc.wlan0.pid) 2>/dev/null || true
        rm -f /var/run/udhcpc.wlan0.pid
    fi
    
    # Kill wpa_supplicant
    killall wpa_supplicant 2>/dev/null || true
    
    # Bring down interface
    /sbin/ifconfig wlan0 down 2>/dev/null || true
    
    echo "OK"
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0
